<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Typora Theme Preview</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		/* Minimal reset - let theme take full control */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		html, body {
			width: 100%;
			height: 100%;
			overflow: auto;
		}

		/* Theme will be injected here */
	</style>
</head>
<body>
	<!-- Typora-style structure -->
	<div id="write">
		<!-- Content will be synced from main editor -->
	</div>

	<script>
		// Listen for messages from parent window
		window.addEventListener('message', function(event) {
			// Verify origin for security
			if (event.origin !== window.location.origin) {
				return;
			}

			const data = event.data;

			if (data.type === 'LOAD_THEME') {
				// Load theme CSS
				loadTheme(data.themeCSS);
			} else if (data.type === 'UPDATE_CONTENT') {
				// Update rendered HTML
				updateContent(data.html);
			} else if (data.type === 'CLOSE') {
				// Close this window
				window.close();
			}
		});

		function loadTheme(css) {
			// Remove existing theme if any
			const existingTheme = document.getElementById('typora-theme');
			if (existingTheme) {
				existingTheme.remove();
			}

			// Create style element with theme CSS
			const styleElement = document.createElement('style');
			styleElement.id = 'typora-theme';
			styleElement.textContent = css;
			document.head.appendChild(styleElement);

			console.log('Typora theme loaded in dedicated window');
		}

		function updateContent(html) {
			// Update the #write container with rendered markdown
			const writeElement = document.getElementById('write');
			if (writeElement) {
				writeElement.innerHTML = html;
			}
		}

		// Notify parent that window is ready
		if (window.opener) {
			window.opener.postMessage({
				type: 'TYPORA_WINDOW_READY'
			}, window.location.origin);
		}

		// Handle window close
		window.addEventListener('beforeunload', function() {
			if (window.opener) {
				window.opener.postMessage({
					type: 'TYPORA_WINDOW_CLOSED'
				}, window.location.origin);
			}
		});
	</script>
</body>
</html>
